<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LuxeTime Watches Lookup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      padding: 40px 20px;
      background: linear-gradient(135deg, #000000, #434343);
      color: #fff;
    }
    .container {
      background: rgba(0, 0, 0, 0.7);
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.5);
      max-width: 1200px;
      margin: 0 auto;
    }
    .logo {
      max-width: 200px;
      display: block;
      margin: 0 auto 20px auto;
    }
    h1 {
      text-align: center;
      font-size: 1.8rem;
      color: #d4af37;
      margin-bottom: 40px;
    }
    .lookup-grid {
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
    }
    .lookup-section {
      flex: 1;
      min-width: 300px;
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 8px;
      max-height: 900px;
      overflow-y: auto;
    }
    .lookup-section h2 {
      color: #d4af37;
      margin-top: 0;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
      color: #d4af37;
    }
    input, textarea, button {
      padding: 10px;
      font-size: 1rem;
      margin-top: 5px;
      width: 100%;
      box-sizing: border-box;
      border-radius: 6px;
      border: 1px solid #555;
      background: #222;
      color: #fff;
      resize: vertical;
    }
    button {
      background: #d4af37;
      color: #000;
      border: none;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
      margin-top: 15px;
    }
    button:hover {
      background: #b9972f;
      transform: translateY(-2px);
    }
    .results {
      margin-top: 40px;
      text-align: left;
      overflow-x: auto;
    }
    .card {
      background: #111;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }
    .manufacturer-line {
      font-weight: bold;
      font-size: 1rem;
      color: #d4af37;
      margin: 0 0 10px 0;
    }
    .card-images {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      max-width: 150px;
    }
    .watch-image {
      width: 100%;
      border-radius: 6px;
      display: block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      table-layout: fixed;
    }
    table th {
      background: #d4af37;
      color: #000;
      padding: 10px;
      cursor: pointer;
    }
    table td {
      background: #111;
      border: 1px solid #333;
      padding: 10px;
      word-wrap: break-word;
      white-space: normal;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="assets/LuxeTime Circle Black Logo.png" alt="LuxeTime Logo" class="logo" />
    <h1>LuxeTime Watches Lookup</h1>

    <div class="lookup-grid">

      <!-- Reference Lookup and CRUD -->
      <div class="lookup-section">
        <h2>Reference Lookup</h2>
        <input type="text" id="refInput" placeholder="Enter Reference Number" />
        <button onclick="lookupReference()">Search Reference</button>
        <button onclick="showAddReferenceForm()">Add New Reference</button>

        <div id="refFormContainer" style="margin-top:20px; display:none;">
          <h3 id="formTitle">Add New Reference</h3>

          <label for="ref_reference">Reference</label>
          <input id="ref_reference" type="text" />

          <label for="ref_manufacturer">Manufacturer</label>
          <input id="ref_manufacturer" type="text" />

          <label for="ref_collection">Collection</label>
          <input id="ref_collection" type="text" />

          <label for="ref_retail_price">Retail Price</label>
          <input id="ref_retail_price" type="text" />

          <label for="ref_dial">Dial</label>
          <input id="ref_dial" type="text" />

          <label for="ref_case">Case</label>
          <input id="ref_case" type="text" />

          <label for="ref_bracelet">Bracelet</label>
          <input id="ref_bracelet" type="text" />

          <label for="ref_movement">Movement</label>
          <input id="ref_movement" type="text" />

          <label for="ref_year_introduced">Year Introduced</label>
          <input id="ref_year_introduced" type="text" />

          <label for="ref_notes">Notes</label>
          <textarea id="ref_notes" rows="3"></textarea>

          <button onclick="saveReference()">Save</button>
          <button onclick="cancelReferenceForm()">Cancel</button>
          <button id="deleteButton" style="background:#b93a3a; color:#fff; display:none;" onclick="deleteReference()">Delete</button>
        </div>
      </div>

      <!-- Grey Market Lookup -->
      <div class="lookup-section">
        <h2>Grey Market Lookup</h2>
        <input type="text" id="greyMarketInput" placeholder="Enter Model (partial ok)" />
        <button onclick="lookupGreyMarket()">Search Grey Market</button>
      </div>
    </div>

    <div id="results" class="results"></div>
  </div>

<script>
  let currentEditingRef = null;

  function showAddReferenceForm() {
    currentEditingRef = null;
    document.getElementById('formTitle').innerText = 'Add New Reference';
    clearReferenceForm();
    document.getElementById('deleteButton').style.display = 'none';
    document.getElementById('refFormContainer').style.display = 'block';
  }

  function showEditReferenceForm(data) {
    currentEditingRef = data.reference;
    document.getElementById('formTitle').innerText = 'Edit Reference';
    document.getElementById('ref_reference').value = data.reference || '';
    document.getElementById('ref_manufacturer').value = data.manufacturer || '';
    document.getElementById('ref_collection').value = data.collection || '';
    document.getElementById('ref_retail_price').value = data.retail_price || '';
    document.getElementById('ref_dial').value = data.dial || '';
    document.getElementById('ref_case').value = data.case || '';
    document.getElementById('ref_bracelet').value = data.bracelet || '';
    document.getElementById('ref_movement').value = data.movement || '';
    document.getElementById('ref_year_introduced').value = data.year_introduced || '';
    document.getElementById('ref_notes').value = data.notes || '';
    document.getElementById('deleteButton').style.display = 'inline-block';
    document.getElementById('refFormContainer').style.display = 'block';
  }

  function clearReferenceForm() {
    const fields = ['ref_reference','ref_manufacturer','ref_collection','ref_retail_price','ref_dial','ref_case','ref_bracelet','ref_movement','ref_year_introduced','ref_notes'];
    fields.forEach(id => document.getElementById(id).value = '');
  }

  function cancelReferenceForm() {
    document.getElementById('refFormContainer').style.display = 'none';
  }

  async function saveReference() {
    const data = {
      reference: document.getElementById('ref_reference').value.trim(),
      manufacturer: document.getElementById('ref_manufacturer').value.trim(),
      collection: document.getElementById('ref_collection').value.trim(),
      retail_price: document.getElementById('ref_retail_price').value.trim(),
      dial: document.getElementById('ref_dial').value.trim(),
      case: document.getElementById('ref_case').value.trim(),
      bracelet: document.getElementById('ref_bracelet').value.trim(),
      movement: document.getElementById('ref_movement').value.trim(),
      year_introduced: document.getElementById('ref_year_introduced').value.trim(),
      notes: document.getElementById('ref_notes').value.trim(),
    };

    if (!data.reference) {
      alert('Reference is required!');
      return;
    }

    try {
      let url = '/.netlify/functions/add';
      let method = 'POST';
      let body = JSON.stringify(data);

      if (currentEditingRef) {
        url = '/.netlify/functions/update';
        body = JSON.stringify({ reference: currentEditingRef, fields: data });
      }

      const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body });
      if (!res.ok) throw new Error('Network response was not ok');

      alert(currentEditingRef ? 'Reference updated' : 'Reference added');
      cancelReferenceForm();
      lookupReference();

    } catch (err) {
      alert('Error saving reference: ' + err.message);
      console.error(err);
    }
  }

  async function deleteReference() {
    if (!currentEditingRef) return;
    if (!confirm(`Are you sure you want to delete reference "${currentEditingRef}"?`)) return;

    try {
      const res = await fetch('/.netlify/functions/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reference: currentEditingRef })
      });
      if (!res.ok) throw new Error('Network response was not ok');

      alert('Reference deleted');
      cancelReferenceForm();
      lookupReference();

    } catch (err) {
      alert('Error deleting reference: ' + err.message);
      console.error(err);
    }
  }

  async function lookupReference() {
    const ref = document.getElementById('refInput').value.trim();
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = '';

    if (!ref) {
      alert('Please enter a reference number.');
      return;
    }

    resultsDiv.innerHTML = '<div>Searching...</div>';

    try {
      const res = await fetch(`/.netlify/functions/lookup?ref=${encodeURIComponent(ref)}`);
      if (!res.ok) throw new Error('Network response was not ok');
      const data = await res.json();

      if (!Array.isArray(data) || data.length === 0) {
        resultsDiv.innerHTML = `<div>No Reference matches found.</div><button onclick="showAddReferenceForm()">Add New Reference</button>`;
        return;
      }

      resultsDiv.innerHTML = data.map(item => {
        const imagesHtml = (item.images || []).map(filename => 
          `<img src="assets/${filename}" alt="${item.reference} image" class="watch-image" />`
        ).join('');

        return `
          <div class="card">
            <div class="card-images">${imagesHtml}</div>
            <div>
              <p class="manufacturer-line">${item.manufacturer || 'N/A'} — Ref: ${item.reference}</p>
              <p>Collection: ${item.collection || 'N/A'}</p>
              <p>Retail Price: ${item.retail_price || 'N/A'}</p>
              <p>Dial: ${item.dial || 'N/A'}</p>
              <p>Case: ${item.case || 'N/A'}</p>
              <p>Bracelet: ${item.bracelet || 'N/A'}</p>
              <p>Movement: ${item.movement || 'N/A'}</p>
              <p><strong>Notes:</strong> ${item.notes || ''}</p>
              <button onclick='showEditReferenceForm(${JSON.stringify(item).replace(/'/g, "\\'")})'>Edit</button>
            </div>
          </div>
        `;
      }).join('');
    } catch (err) {
      resultsDiv.innerHTML = `<div>Error fetching reference data.</div>`;
      console.error(err);
    }
  }

  async function lookupGreyMarket() {
    const ref = document.getElementById('greyMarketInput').value.trim();
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = '';

    if (!ref) {
      alert('Enter a model number.');
      return;
    }

    resultsDiv.innerHTML = '<div>Searching Grey Market...</div>';

    try {
      const res = await fetch(`/.netlify/functions/greyMarketLookup?reference=${encodeURIComponent(ref)}`);
      if (!res.ok) throw new Error('Network response was not ok');
      const data = await res.json();

      if (!Array.isArray(data) || data.length === 0) {
        resultsDiv.innerHTML = `<div>No Grey Market matches found.</div>`;
        return;
      }

      let html = `<table id="greyMarketTable">
        <thead>
          <tr>
            <th onclick="sortTable(0)">Date Entered</th>
            <th onclick="sortTable(1)">Year</th>
            <th onclick="sortTable(2)">Model</th>
            <th onclick="sortTable(3)">Model Name</th>
            <th onclick="sortTable(4)">Nickname or Dial</th>
            <th onclick="sortTable(5)">Bracelet</th>
            <th onclick="sortTable(6)">Bracelet Metal/Color</th>
            <th onclick="sortTable(7)">Price</th>
            <th onclick="sortTable(8)">Full Set</th>
            <th onclick="sortTable(9)">Retail Ready</th>
            <th onclick="sortTable(10)">Current Retail</th>
            <th onclick="sortTable(11)">Dealer</th>
            <th onclick="sortTable(12)">Comments</th>
          </tr>
        </thead><tbody>`;

      data.forEach(item => {
        html += `<tr>
          <td>${item["Date Entered"] || ''}</td>
          <td>${item.Year || ''}</td>
          <td>${item.Model || ''}</td>
          <td>${item["Model Name"] || ''}</td>
          <td>${item["Nickname or Dial"] || ''}</td>
          <td>${item.Bracelet || ''}</td>
          <td>${item["Bracelet Metal/Color"] || ''}</td>
          <td>${item.Price || ''}</td>
          <td>${item["Full Set"] || ''}</td>
          <td>${item["Retail Ready"] || ''}</td>
          <td>${item["Current Retail (Not Inc Tax)"] || ''}</td>
          <td>${item.Dealer || ''}</td>
          <td>${item.Comments || ''}</td>
        </tr>`;
      });

      html += `</tbody></table>`;
      resultsDiv.innerHTML = html;
    } catch (err) {
      resultsDiv.innerHTML = `<div>Error fetching grey market data.</div>`;
      console.error(err);
    }
  }

  function sortTable(n) {
    const table = document.getElementById("greyMarketTable");
    let switching = true;
    let dir = "asc";
    let switchcount = 0;

    while (switching) {
      switching = false;
      const rows = table.rows;
      let shouldSwitch;
      let i = 1;

      for (; i < (rows.length - 1); i++) {
        shouldSwitch = false;
        let x = rows[i].getElementsByTagName("TD")[n];
        let y = rows[i + 1].getElementsByTagName("TD")[n];

        if (dir === "asc") {
          if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
            shouldSwitch = true;
            break;
          }
        } else if (dir === "desc") {
          if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
            shouldSwitch = true;
            break;
          }
        }
      }
      if (shouldSwitch) {
        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
        switching = true;
        switchcount++;
      } else {
        if (switchcount === 0 && dir === "asc") {
          dir = "desc";
          switching = true;
        }
      }
    }
  }
</script>
</body>
</html>
