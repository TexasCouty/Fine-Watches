<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>LuxeTime Watches Lookup</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  /* Your existing styles */
  body {
    font-family: 'Helvetica Neue', Arial, sans-serif;
    margin: 0;
    padding: 40px 20px;
    background: linear-gradient(135deg, #000000, #434343);
    color: #fff;
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
  }
  .logo {
    max-width: 200px;
    display: block;
    margin: 0 auto 20px auto;
  }
  h1 {
    text-align: center;
    font-size: 1.8rem;
    color: #d4af37;
    margin-bottom: 40px;
  }
  .lookup-grid {
    display: flex;
    gap: 40px;
    flex-wrap: wrap;
  }
  .lookup-section {
    flex: 1;
    min-width: 320px;
    background: #121212;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 0 15px #d4af37aa;
    max-height: 900px;
    overflow-y: auto;
    position: relative;
  }
  .lookup-section h2 {
    color: #d4af37;
    margin-top: 0;
    font-weight: 700;
    text-shadow: 0 0 5px #b9972f;
  }
  label {
    display: block;
    margin-top: 12px;
    font-weight: 700;
    color: #d4af37;
  }
  input, textarea, button {
    padding: 10px;
    font-size: 1rem;
    margin-top: 5px;
    width: 100%;
    box-sizing: border-box;
    border-radius: 6px;
    border: 1px solid #d4af37;
    background: #222;
    color: #eee;
    resize: vertical;
    transition: border-color 0.3s ease;
  }
  input:focus, textarea:focus {
    outline: none;
    border-color: #f7df72;
    box-shadow: 0 0 5px #f7df72;
    background: #1c1c1c;
  }
  button {
    background: transparent;
    border: 2px solid #d4af37;
    color: #d4af37;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
    padding: 12px 20px;
    border-radius: 6px;
    width: 100%;
    box-sizing: border-box;
    margin-top: 15px;
  }
  button:hover {
    background: #d4af37;
    color: #000;
    box-shadow: 0 0 15px #d4af37;
    transform: translateY(-2px);
  }
  .results {
    margin-top: 40px;
    text-align: left;
    overflow-x: auto;
  }
  .card {
    background: #121212;
    border: 1px solid #d4af37;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    display: flex;
    gap: 20px;
    align-items: flex-start;
    box-shadow: 0 0 10px #d4af37aa;
  }
  .manufacturer-line {
    font-weight: bold;
    font-size: 1rem;
    color: #d4af37;
    margin: 0 0 10px 0;
  }
  .card-images {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    max-width: 150px;
  }
  .watch-image {
    width: 100%;
    border-radius: 8px;
    border: 1px solid #d4af37;
    display: block;
  }
  /* Autocomplete styles */
  .autocomplete-items {
    position: absolute;
    border: 1px solid #d4af37;
    border-top: none;
    z-index: 1001;
    top: 100%;
    left: 0;
    right: 0;
    background: #222;
    color: #eee;
    max-height: 200px;
    overflow-y: auto;
    border-radius: 0 0 8px 8px;
    width: 100%;
    box-sizing: border-box;
  }
  .autocomplete-items div {
    padding: 10px;
    cursor: pointer;
    color: #eee;
  }
  .autocomplete-items div:hover {
    background: #d4af37;
    color: #000;
  }
  /* Multi-record picker popup */
  #recordPicker {
    position: absolute;
    z-index: 1100;
    top: calc(100% + 5px);
    left: 0;
    right: 0;
    max-height: 250px;
    overflow-y: auto;
    background: #222;
    border: 1px solid #d4af37;
    border-radius: 0 0 8px 8px;
    box-sizing: border-box;
  }
  #recordPicker div {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #d4af37aa;
    color: #eee;
  }
  #recordPicker div:hover {
    background: #d4af37;
    color: #000;
  }
</style>
</head>
<body>
<div class="container">
  <img src="assets/LuxeTime Square Black Logo.png" alt="LuxeTime Logo" class="logo" />
  <h1>LuxeTime Watches Lookup</h1>

  <div class="lookup-grid">
    <!-- Grey Market Lookup Section -->
    <div class="lookup-section" style="position:relative;">
      <h2>Grey Market Lookup</h2>
      <input type="text" id="greyMarketInput" placeholder="Enter Model (partial ok)" />
      <button onclick="lookupGreyMarket()">Search Grey Market</button>
      <button onclick="showAddGreyMarketForm()">Add New Grey Market Entry</button>

      <div id="greyMarketFormContainer" style="margin-top:20px; display:none;">
        <h3 id="greyMarketFormTitle">Add New Grey Market Entry</h3>

        <label for="gm_date_entered">Date Entered</label>
        <input type="date" id="gm_date_entered" />

        <label for="gm_year">Year</label>
        <input type="text" id="gm_year" />

        <label for="gm_model">Model</label>
        <input type="text" id="gm_model" />

        <label for="gm_model_name" autocomplete="off">Model Name</label>
        <input type="text" id="gm_model_name" />

        <div id="recordPicker" style="display:none;"></div>

        <label for="gm_nickname">Nickname or Dial</label>
        <input type="text" id="gm_nickname" />

        <label for="gm_bracelet">Bracelet</label>
        <input type="text" id="gm_bracelet" />

        <label for="gm_bracelet_metal_color">Bracelet Metal/Color</label>
        <input type="text" id="gm_bracelet_metal_color" />

        <label for="gm_price">Price</label>
        <input type="text" id="gm_price" />

        <label for="gm_full_set">Full Set</label>
        <input type="text" id="gm_full_set" />

        <label for="gm_retail_ready">Retail Ready</label>
        <input type="text" id="gm_retail_ready" />

        <label for="gm_current_retail">Current Retail (Not Inc Tax)</label>
        <input type="text" id="gm_current_retail" />

        <label for="gm_dealer">Dealer</label>
        <input type="text" id="gm_dealer" />

        <label for="gm_comments">Comments</label>
        <textarea id="gm_comments" rows="3"></textarea>

        <button onclick="saveGreyMarketEntry()">Save</button>
        <button onclick="cancelGreyMarketForm()">Cancel</button>
        <button id="gm_delete_button" style="background:#b93a3a; color:#fff; display:none;" onclick="deleteGreyMarketEntry()">Delete</button>
      </div>
    </div>
  </div>

  <div id="results" class="results"></div>
</div>

<script>
  let greyMarketData = [];
  let modelNameSuggestions = [];
  let currentEditingGMModel = null;

  async function fetchGreyMarketData() {
    console.log('Fetching full grey market data...');
    try {
      const res = await fetch('/.netlify/functions/greyMarketLookup?reference=');
      if (!res.ok) throw new Error('Failed to fetch grey market data');
      greyMarketData = await res.json();

      const namesSet = new Set();
      greyMarketData.forEach(item => {
        if (item['Model Name']) namesSet.add(item['Model Name'].toUpperCase());
      });
      modelNameSuggestions = Array.from(namesSet).sort();
      console.log('Loaded model names:', modelNameSuggestions);
    } catch (e) {
      console.error('Error loading grey market data:', e);
    }
  }

  function clearGreyMarketForm() {
    const fields = [
      'gm_date_entered','gm_year','gm_model','gm_model_name','gm_nickname',
      'gm_bracelet','gm_bracelet_metal_color','gm_price','gm_full_set',
      'gm_retail_ready','gm_current_retail','gm_dealer','gm_comments'
    ];
    fields.forEach(id => {
      if(id !== 'gm_model_name')
        document.getElementById(id).value = '';
    });
    currentEditingGMModel = null;
    document.getElementById('gm_delete_button').style.display = 'none';
    hideRecordPicker();
  }

  function showAddGreyMarketForm() {
    document.getElementById('greyMarketFormTitle').innerText = 'Add New Grey Market Entry';
    clearGreyMarketForm();
    document.getElementById('greyMarketFormContainer').style.display = 'block';
  }

  function cancelGreyMarketForm() {
    document.getElementById('greyMarketFormContainer').style.display = 'none';
    hideRecordPicker();
  }

  const modelNameInput = document.getElementById('gm_model_name');
  const recordPicker = document.getElementById('recordPicker');

  modelNameInput.addEventListener('input', function() {
    const val = this.value.trim().toUpperCase();
    if (!val) {
      hideRecordPicker();
      return;
    }

    const filteredNames = modelNameSuggestions.filter(name => name.startsWith(val));
    if (filteredNames.length === 0) {
      hideRecordPicker();
      return;
    }

    showRecordPickerForModelName(filteredNames[0]);
  });

  function showRecordPickerForModelName(modelName) {
    const matches = greyMarketData.filter(item => 
      item['Model Name'] && item['Model Name'].toUpperCase() === modelName.toUpperCase()
    );

    if (matches.length === 0) {
      hideRecordPicker();
      return;
    }

    recordPicker.innerHTML = '';
    matches.forEach(record => {
      const div = document.createElement('div');
      div.textContent = `${record.Model} | ${record['Nickname or Dial'] || ''} | ${record.Bracelet || ''}`;
      div.addEventListener('click', () => {
        autofillGreyMarketForm(record);
        hideRecordPicker();
      });
      recordPicker.appendChild(div);
    });
    recordPicker.style.display = 'block';
  }

  function hideRecordPicker() {
    recordPicker.style.display = 'none';
    recordPicker.innerHTML = '';
  }

  function autofillGreyMarketForm(record) {
    console.log('Autofilling form for selected record:', record);
    document.getElementById('gm_date_entered').value = record['Date Entered'] || '';
    document.getElementById('gm_year').value = record.Year || '';
    document.getElementById('gm_model').value = record.Model || '';
    document.getElementById('gm_model_name').value = record['Model Name'] || '';
    document.getElementById('gm_nickname').value = record['Nickname or Dial'] || '';
    document.getElementById('gm_bracelet').value = record.Bracelet || '';
    document.getElementById('gm_bracelet_metal_color').value = record['Bracelet Metal/Color'] || '';
    document.getElementById('gm_price').value = record.Price || '';
    document.getElementById('gm_full_set').value = record['Full Set'] || '';
    document.getElementById('gm_retail_ready').value = record['Retail Ready'] || '';
    document.getElementById('gm_current_retail').value = record['Current Retail (Not Inc Tax)'] || '';
    document.getElementById('gm_dealer').value = record.Dealer || '';
    document.getElementById('gm_comments').value = record.Comments || '';
    document.getElementById('gm_delete_button').style.display = 'inline-block';
    currentEditingGMModel = record.Model;
  }

  async function saveGreyMarketEntry() {
    const rawModelName = document.getElementById('gm_model_name').value.trim();
    const data = {
      "Date Entered": document.getElementById('gm_date_entered').value.trim(),
      "Year": document.getElementById('gm_year').value.trim(),
      "Model": document.getElementById('gm_model').value.trim(),
      "Model Name": rawModelName.toUpperCase(),
      "Nickname or Dial": document.getElementById('gm_nickname').value.trim(),
      "Bracelet": document.getElementById('gm_bracelet').value.trim(),
      "Bracelet Metal/Color": document.getElementById('gm_bracelet_metal_color').value.trim(),
      "Price": document.getElementById('gm_price').value.trim(),
      "Full Set": document.getElementById('gm_full_set').value.trim(),
      "Retail Ready": document.getElementById('gm_retail_ready').value.trim(),
      "Current Retail (Not Inc Tax)": document.getElementById('gm_current_retail').value.trim(),
      "Dealer": document.getElementById('gm_dealer').value.trim(),
      "Comments": document.getElementById('gm_comments').value.trim()
    };

    if (!data.Model) {
      alert('Model is required!');
      return;
    }

    try {
      let url = '/.netlify/functions/addgreyMarket';
      let method = 'POST';
      let body = JSON.stringify(data);

      if (currentEditingGMModel) {
        url = '/.netlify/functions/updateGreyMarket';
        body = JSON.stringify({ Model: currentEditingGMModel, fields: data });
      }

      const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body });
      if (!res.ok) throw new Error('Network response was not ok');

      alert(currentEditingGMModel ? 'Grey Market entry updated' : 'Grey Market entry added');
      cancelGreyMarketForm();
      lookupGreyMarket();

    } catch (err) {
      alert('Error saving Grey Market entry: ' + err.message);
      console.error(err);
    }
  }

  async function deleteGreyMarketEntry() {
    if (!currentEditingGMModel) return;
    if (!confirm(`Are you sure you want to delete model "${currentEditingGMModel}"?`)) return;

    try {
      const res = await fetch('/.netlify/functions/deleteGreyMarket', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ Model: currentEditingGMModel })
      });
      if (!res.ok) throw new Error('Network response was not ok');

      alert('Grey Market entry deleted');
      cancelGreyMarketForm();
      lookupGreyMarket();

    } catch (err) {
      alert('Error deleting Grey Market entry: ' + err.message);
      console.error(err);
    }
  }

  async function lookupGreyMarket() {
    const ref = document.getElementById('greyMarketInput').value.trim();
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = '';

    if (!ref) {
      alert('Enter a model number.');
      return;
    }

    console.log(`🟢 Searching Grey Market for reference: "${ref}"`);
    resultsDiv.innerHTML = '<div>Searching Grey Market...</div>';

    try {
      const res = await fetch(`/.netlify/functions/greyMarketLookup?reference=${encodeURIComponent(ref)}`);
      console.log(`🟢 Lookup response status: ${res.status}`);
      if (!res.ok) throw new Error('Network response was not ok');
      const data = await res.json();
      console.log(`🟢 Lookup returned ${data.length} results`);

      if (!Array.isArray(data) || data.length === 0) {
        resultsDiv.innerHTML = `<div>No Grey Market matches found.</div>`;
        return;
      }

      let html = `<table id="greyMarketTable">
        <thead>
          <tr>
            <th onclick="sortTable(0)">Date Entered</th>
            <th onclick="sortTable(1)">Year</th>
            <th onclick="sortTable(2)">Model</th>
            <th onclick="sortTable(3)">Model Name</th>
            <th onclick="sortTable(4)">Nickname or Dial</th>
            <th onclick="sortTable(5)">Bracelet</th>
            <th onclick="sortTable(6)">Bracelet Metal/Color</th>
            <th onclick="sortTable(7)">Price</th>
            <th onclick="sortTable(8)">Full Set</th>
            <th onclick="sortTable(9)">Retail Ready</th>
            <th onclick="sortTable(10)">Current Retail</th>
            <th onclick="sortTable(11)">Dealer</th>
            <th onclick="sortTable(12)">Comments</th>
            <th>Actions</th>
          </tr>
        </thead><tbody>`;

      data.forEach(item => {
        html += `<tr>
          <td>${item["Date Entered"] || ''}</td>
          <td>${item.Year || ''}</td>
          <td>${item.Model || ''}</td>
          <td>${item["Model Name"] || ''}</td>
          <td>${item["Nickname or Dial"] || ''}</td>
          <td>${item.Bracelet || ''}</td>
          <td>${item["Bracelet Metal/Color"] || ''}</td>
          <td>${item.Price || ''}</td>
          <td>${item["Full Set"] || ''}</td>
          <td>${item["Retail Ready"] || ''}</td>
          <td>${item["Current Retail (Not Inc Tax)"] || ''}</td>
          <td>${item.Dealer || ''}</td>
          <td>${item.Comments || ''}</td>
          <td><button onclick='showEditGreyMarketForm(${JSON.stringify(item).replace(/'/g, "\\'")})'>Edit</button></td>
        </tr>`;
      });

      html += `</tbody></table>`;
      resultsDiv.innerHTML = html;
    } catch (err) {
      resultsDiv.innerHTML = `<div>Error fetching grey market data.</div>`;
      console.error(err);
    }
  }

  function sortTable(n) {
    const table = document.getElementById("greyMarketTable");
    let switching = true;
    let dir = "asc";
    let switchcount = 0;

    while (switching) {
      switching = false;
      const rows = table.rows;
      let shouldSwitch;
      let i = 1;

      for (; i < (rows.length - 1); i++) {
        shouldSwitch = false;
        let x = rows[i].getElementsByTagName("TD")[n];
        let y = rows[i + 1].getElementsByTagName("TD")[n];

        if (dir === "asc") {
          if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
            shouldSwitch = true;
            break;
          }
        } else if (dir === "desc") {
          if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
            shouldSwitch = true;
            break;
          }
        }
      }
      if (shouldSwitch) {
        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
        switching = true;
        switchcount++;
      } else {
        if (switchcount === 0 && dir === "asc") {
          dir = "desc";
          switching = true;
        }
      }
    }
  }

  window.addEventListener('DOMContentLoaded', async () => {
    await fetchGreyMarketData();
  });
</script>
</body>
</html>
