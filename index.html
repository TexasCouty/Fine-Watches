<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LuxeTime Watches Lookup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ... your existing styles unchanged ... */
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      padding: 40px 20px;
      background: linear-gradient(135deg, #000000, #434343);
      color: #fff;
    }
    .container {
      background: rgba(0, 0, 0, 0.7);
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.5);
      max-width: 1200px;
      margin: 0 auto;
    }
    /* ... all your other styles ... */
    .autocomplete-items {
      position: absolute;
      border: 1px solid #d4af37;
      border-top: none;
      z-index: 99;
      top: 100%;
      left: 0;
      right: 0;
      background: #222;
      color: #eee;
      max-height: 200px;
      overflow-y: auto;
      border-radius: 0 0 8px 8px;
    }
    .autocomplete-items div {
      padding: 10px;
      cursor: pointer;
      color: #eee;
    }
    .autocomplete-items div:hover {
      background: #d4af37;
      color: #000;
    }
    .autocomplete-items::-webkit-scrollbar {
      width: 8px;
    }
    .autocomplete-items::-webkit-scrollbar-thumb {
      background-color: #d4af37aa;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Your existing markup here -->
    <img src="assets/LuxeTime Circle Black Logo.png" alt="LuxeTime Logo" class="logo" />
    <h1>LuxeTime Watches Lookup</h1>

    <div class="lookup-grid">
      <!-- Reference Lookup Section -->
      <div class="lookup-section">
        <h2>Reference Lookup</h2>
        <input type="text" id="refInput" placeholder="Enter Reference Number" />
        <button onclick="lookupReference()">Search Reference</button>
        <button onclick="showAddReferenceForm()">Add New Reference</button>

        <div id="refFormContainer" style="margin-top:20px; display:none;">
          <h3 id="formTitle">Add New Reference</h3>
          <!-- input fields here ... -->
          <!-- same as before -->
        </div>
      </div>

      <!-- Grey Market Lookup Section -->
      <div class="lookup-section" style="position:relative;">
        <h2>Grey Market Lookup</h2>
        <input type="text" id="greyMarketInput" placeholder="Enter Model (partial ok)" />
        <button onclick="lookupGreyMarket()">Search Grey Market</button>
        <button onclick="showAddGreyMarketForm()">Add New Grey Market Entry</button>

        <div id="greyMarketFormContainer" style="margin-top:20px; display:none;">
          <h3 id="greyMarketFormTitle">Add New Grey Market Entry</h3>
          <!-- grey market input fields here ... -->
          <!-- same as before -->
          <label for="gm_model_name">Model Name</label>
          <input type="text" id="gm_model_name" autocomplete="off" />
          <!-- rest inputs -->
          <button onclick="saveGreyMarketEntry()">Save</button>
          <button onclick="cancelGreyMarketForm()">Cancel</button>
          <button id="gm_delete_button" style="background:#b93a3a; color:#fff; display:none;" onclick="deleteGreyMarketEntry()">Delete</button>
        </div>
      </div>
    </div>

    <div id="results" class="results"></div>
  </div>

<script>
  // Other existing functions unchanged...

  // Fixed autocomplete setup with proper closure of input in scope
  let modelNameSuggestions = [];

  async function fetchModelNameSuggestions() {
    console.log('ðŸŸ¡ Fetching Model Name Suggestions...');
    try {
      const res = await fetch('/.netlify/functions/greyMarketLookup?reference=');
      console.log(`ðŸŸ¡ Fetch response status: ${res.status}`);
      if (!res.ok) throw new Error('Failed to load model names');
      const data = await res.json();
      console.log(`ðŸŸ¡ Received ${data.length} entries for autocomplete`);
      const namesSet = new Set();
      data.forEach(item => {
        if (item['Model Name']) namesSet.add(item['Model Name'].toUpperCase());
      });
      modelNameSuggestions = Array.from(namesSet).sort();
      console.log('ðŸŸ¡ Autocomplete model names:', modelNameSuggestions);
    } catch (e) {
      console.error('ðŸ›‘ Error fetching model name suggestions:', e);
    }
  }

  function setupAutocomplete(inputId) {
    const input = document.getElementById(inputId);

    function closeAllLists(elmnt) {
      const items = document.getElementsByClassName('autocomplete-items');
      for (let i = items.length - 1; i >= 0; i--) {
        if (elmnt != items[i] && elmnt != input) {
          items[i].parentNode.removeChild(items[i]);
        }
      }
    }

    input.addEventListener('input', () => {
      closeAllLists();
      if (!input.value) return false;
      const val = input.value.toUpperCase();
      const list = document.createElement('div');
      list.setAttribute('id', inputId + '-autocomplete-list');
      list.setAttribute('class', 'autocomplete-items');
      input.parentNode.appendChild(list);

      let count = 0;
      for (let name of modelNameSuggestions) {
        if (name.startsWith(val)) {
          const item = document.createElement('div');
          item.innerHTML = `<strong>${name.substr(0, val.length)}</strong>${name.substr(val.length)}`;
          item.addEventListener('click', () => {
            input.value = name;
            closeAllLists();
          });
          list.appendChild(item);
          count++;
          if (count >= 10) break;
        }
      }
    });

    document.addEventListener('click', (e) => {
      closeAllLists(e.target);
    });
  }

  window.addEventListener('DOMContentLoaded', async () => {
    await fetchModelNameSuggestions();
    setupAutocomplete('gm_model_name');
  });

  // ... Rest of your CRUD functions unchanged (save, delete, lookup, etc.) ...

</script>
</body>
</html>

