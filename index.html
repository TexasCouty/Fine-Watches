<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fine Watches Reference Lookup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ‚úÖ README: LuxeTime theme + balanced fixed table -->
  <style>
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      padding: 40px 20px;
      background: linear-gradient(135deg, #000000, #434343);
      color: #fff;
    }
    .container {
      background: rgba(0, 0, 0, 0.7);
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.5);
      max-width: 1200px;
      margin: 0 auto;
    }
    .logo {
      max-width: 200px;
      height: auto;
      display: block;
      margin: 0 auto 20px auto;
    }
    h1 {
      font-size: 1.8rem;
      color: #d4af37;
      margin-bottom: 30px;
      text-align: center;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
      color: #d4af37;
    }
    input, button, textarea {
      padding: 10px;
      font-size: 1rem;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
      border-radius: 6px;
    }
    input, textarea {
      border: 1px solid #555;
      background: #222;
      color: #fff;
    }
    input::placeholder {
      color: #aaa;
    }
    button {
      background: #d4af37;
      color: #000;
      border: none;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    button:hover {
      background: #b9972f;
      transform: translateY(-2px);
    }
    .results {
      margin-top: 30px;
      text-align: left;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      table-layout: fixed;
    }
    table th {
      background: #d4af37;
      color: #000;
      padding: 10px;
      cursor: pointer;
    }
    table td {
      background: #111;
      border: 1px solid #333;
      padding: 10px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
    }
    @media (max-width: 700px) {
      .card { flex-direction: column; }
      .card-text, .card-images { flex: 1 1 100%; padding: 0; }
      .card-images { grid-template-columns: repeat(2, 1fr); }
      .watch-image { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="assets/LuxeTime Circle Black Logo.png" alt="LuxeTime Logo" class="logo" />
    <h1>Fine Watches Reference Lookup</h1>

    <!-- ‚úÖ Reference Lookup -->
    <input type="text" id="refInput" placeholder="Enter Reference Number (partial or complete)" />
    <button onclick="lookupReference()">Search</button>

    <!-- ‚úÖ Grey Market Lookup -->
    <input type="text" id="greyMarketInput" placeholder="Enter Reference Number for Grey Market Price" />
    <button onclick="lookupGreyMarket()">Search Grey Market</button>

    <div id="results" class="results"></div>
  </div>

  <script>
    // ‚úÖ Reference Lookup unchanged...
    async function lookupReference() {
      /* Your working code here... (omitted for brevity) */
    }

    async function lookupGreyMarket() {
      const ref = document.getElementById('greyMarketInput').value.trim();
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      if (!ref) {
        alert('Please enter a reference number.');
        return;
      }

      resultsDiv.innerHTML = '<div class="message">Searching Grey Market DB...</div>';

      try {
        const response = await fetch(`/.netlify/functions/greyMarketLookup?reference=${encodeURIComponent(ref)}`);
        if (response.ok) {
          const data = await response.json();

          if (!Array.isArray(data) || data.length === 0) {
            resultsDiv.innerHTML = `<div class="message">No Grey Market matches found.</div>`;
          } else {
            let table = `
              <table id="greyMarketTable">
                <thead>
                  <tr>
                    <th onclick="sortTable(0)">Date Entered</th>
                    <th onclick="sortTable(1)">Year</th>
                    <th onclick="sortTable(2)">Model</th>
                    <th onclick="sortTable(3)">Model Name</th>
                    <th onclick="sortTable(4)">Nickname or Dial</th>
                    <th onclick="sortTable(5)">Bracelet</th>
                    <th onclick="sortTable(6)">Bracelet Metal/Color</th>
                    <th onclick="sortTable(7)">Price</th>
                    <th onclick="sortTable(8)">Full Set</th>
                    <th onclick="sortTable(9)">Retail Ready</th>
                    <th onclick="sortTable(10)">Current Retail (Not Inc Tax)</th>
                    <th onclick="sortTable(11)">Dealer</th>
                    <th onclick="sortTable(12)">Comments</th>
                  </tr>
                </thead>
                <tbody>
            `;

            table += data.map(item => `
              <tr>
                <td>${item["Date Entered"] || 'N/A'}</td>
                <td>${item.Year || 'N/A'}</td>
                <td>${item.Model || 'N/A'}</td>
                <td>${item["Model Name"] || 'N/A'}</td>
                <td>${item["Nickname or Dial"] || 'N/A'}</td>
                <td>${item.Bracelet || 'N/A'}</td>
                <td>${item["Bracelet Metal/Color"] || 'N/A'}</td>
                <td>${item.Price || 'N/A'}</td>
                <td>${item["Full Set"] || 'N/A'}</td>
                <td>${item["Retail Ready"] || 'N/A'}</td>
                <td>${item["Current Retail (Not Inc Tax)"] || 'N/A'}</td>
                <td>${item.Dealer || 'N/A'}</td>
                <td>${item.Comments || ''}</td>
              </tr>
            `).join('');

            table += `</tbody></table>`;
            resultsDiv.innerHTML = table;
          }
        } else {
          resultsDiv.innerHTML = `<div class="message">No Grey Market matches found.</div>`;
        }
      } catch (err) {
        console.error(err);
        resultsDiv.innerHTML = '<div class="message">Error connecting to the server.</div>';
      }
    }

    // ‚úÖ FINAL over-logged sortTable
    function sortTable(n) {
      const table = document.getElementById("greyMarketTable");
      let switching = true;
      let dir = "asc"; 
      let switchcount = 0;

      console.log(`üìå sortTable START column ${n}`);

      while (switching) {
        switching = false;
        const rows = table.rows;
        console.log(`üîç Checking ${rows.length} rows`);

        let shouldSwitch = false; // declared outside for scope
        let i;

        for (i = 1; i < (rows.length - 1); i++) {
          shouldSwitch = false;
          console.log(`Row ${i} compare`);

          let x = rows[i].getElementsByTagName("TD")[n];
          let y = rows[i + 1].getElementsByTagName("TD")[n];
          console.log(` x: "${x.innerHTML.trim()}" | y: "${y.innerHTML.trim()}"`);

          if (dir === "asc") {
            if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
              shouldSwitch = true;
              console.log(`  ‚úÖ Will switch ASC`);
              break;
            }
          } else if (dir === "desc") {
            if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
              shouldSwitch = true;
              console.log(`  ‚úÖ Will switch DESC`);
              break;
            }
          }
        }

        console.log(`‚û°Ô∏è shouldSwitch after loop: ${shouldSwitch}`);
        if (shouldSwitch) {
          console.log(`üîÑ Swapping rows ${i} and ${i + 1}`);
          rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
          switching = true;
          switchcount++;
        } else {
          if (switchcount === 0 && dir === "asc") {
            dir = "desc";
            switching = true;
            console.log(`‚ÜïÔ∏è Switching direction to DESC`);
          }
        }
      }

      console.log(`‚úÖ sortTable DONE`);
    }
  </script>
</body>
</html>
